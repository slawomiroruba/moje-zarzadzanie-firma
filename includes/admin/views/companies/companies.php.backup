<?php
/**
 * Widok zarzƒÖdzania firmami
 *
 * @package WPMZF
 * @subpackage Admin/Views
 */

if (!defined('ABSPATH')) {
    exit;
}

// Renderuj nawigacjƒô i header
WPMZF_View_Helper::render_complete_header(array(
    'title' => 'Firmy',
    'subtitle' => 'ZarzƒÖdzaj firmami w swoim systemie CRM',
    'breadcrumbs' => array(
        array('label' => 'Dashboard', 'url' => admin_url('admin.php?page=wpmzf_dashboard')),
        array('label' => 'Firmy', 'url' => '')
    ),
    'actions' => array(
        array(
            'label' => 'Dodaj firmƒô',
            'url' => admin_url('post-new.php?post_type=company'),
            'icon' => '‚ûï',
            'class' => 'button button-primary'
        ),
        array(
            'label' => 'Import firm',
            'url' => '#',
            'icon' => 'üì•',
            'class' => 'button'
        )
    )
));

// Pobieranie firm
$companies = WPMZF_Company::get_companies();
?>

<div class="wrap">    
    <div class="luna-crm-companies">        
        <div class="luna-crm-companies-grid">
            <?php if (!empty($companies)): ?>
                <?php foreach ($companies as $company): ?>
                    <?php 
                    $company_status = get_field('company_status', $company->id) ?: 'Aktywny';
                    ?>
                    <div class="luna-crm-company-card" data-company-id="<?php echo $company->id; ?>">
                        <div class="company-header">
                            <h3>
                                <a href="<?php echo admin_url('admin.php?page=wpmzf-companies&action=view&company_id=' . $company->id); ?>" class="company-title-link">
                                    <?php echo esc_html($company->name); ?>
                                </a>
                            </h3>
                            <div class="company-status status-<?php echo esc_attr(strtolower(str_replace(' ', '-', $company_status))); ?>">
                                <?php echo esc_html($company_status); ?>
                            </div>
                            <div class="company-actions">
                                <a href="<?php echo admin_url('admin.php?page=wpmzf-companies&action=view&company_id=' . $company->id); ?>" class="button button-small view-company" title="Zobacz szczeg√≥≈Çy">
                                    <span class="dashicons dashicons-visibility"></span>
                                </a>
                                <button class="button button-small edit-company" data-company-id="<?php echo $company->id; ?>">
                                    <span class="dashicons dashicons-edit"></span>
                                </button>
                                <button class="button button-small delete-company" data-company-id="<?php echo $company->id; ?>">
                                    <span class="dashicons dashicons-trash"></span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="company-details">
                            <?php if ($company->nip): ?>
                                <p><strong>NIP:</strong> <?php echo esc_html($company->nip); ?></p>
                            <?php endif; ?>
                            
                            <?php if ($company->phone): ?>
                                <p><strong>Telefon:</strong> <?php echo esc_html($company->phone); ?></p>
                            <?php endif; ?>
                            
                            <?php if ($company->email): ?>
                                <p><strong>Email:</strong> <a href="mailto:<?php echo esc_attr($company->email); ?>"><?php echo esc_html($company->email); ?></a></p>
                            <?php endif; ?>
                            
                            <?php if ($company->website): ?>
                                <p><strong>Strona:</strong> <a href="<?php echo esc_url($company->website); ?>" target="_blank"><?php echo esc_html($company->website); ?></a></p>
                            <?php endif; ?>
                        </div>
                        
                        <div class="company-stats">
                            <?php
                            $persons_count = count(WPMZF_Person::get_persons(array(
                                'meta_query' => array(
                                    array(
                                        'key' => 'company_id',
                                        'value' => $company->id,
                                        'compare' => '='
                                    )
                                )
                            )));
                            
                            $projects_count = count(WPMZF_Project::get_projects(array(
                                'meta_query' => array(
                                    array(
                                        'key' => 'company_id',
                                        'value' => $company->id,
                                        'compare' => '='
                                    )
                                )
                            )));
                            ?>
                            
                            <span class="stat-item">
                                <span class="dashicons dashicons-groups"></span>
                                <?php echo $persons_count; ?> os√≥b
                            </span>
                            
                            <span class="stat-item">
                                <span class="dashicons dashicons-portfolio"></span>
                                <?php echo $projects_count; ?> projekt√≥w
                            </span>
                        </div>
                    </div>
                <?php endforeach; ?>
            <?php else: ?>
                <div class="luna-crm-empty-state">
                    <span class="dashicons dashicons-building"></span>
                    <h3>Brak firm</h3>
                    <p>Dodaj pierwszƒÖ firmƒô do swojego CRM</p>
                    <button class="button button-primary" id="add-first-company">Dodaj firmƒô</button>
                </div>
            <?php endif; ?>
        </div>
    </div>
</div>

<!-- Modal dodawania/edycji firmy -->
<div id="company-modal" class="luna-crm-modal" style="display: none;">
    <div class="luna-crm-modal-content">
        <div class="luna-crm-modal-header">
            <h2 id="modal-title">Dodaj firmƒô</h2>
            <button class="luna-crm-modal-close">&times;</button>
        </div>
        
        <form id="company-form">
            <div class="luna-crm-form-group">
                <label for="company-name">Nazwa firmy *</label>
                <input type="text" id="company-name" name="name" required>
            </div>
            
            <div class="luna-crm-form-group">
                <label for="company-nip">NIP</label>
                <input type="text" id="company-nip" name="nip">
            </div>
            
            <div class="luna-crm-form-group">
                <label for="company-address">Adres</label>
                <textarea id="company-address" name="address" rows="3"></textarea>
            </div>
            
            <div class="luna-crm-form-group">
                <label for="company-phone">Telefon</label>
                <input type="text" id="company-phone" name="phone">
            </div>
            
            <div class="luna-crm-form-group">
                <label for="company-email">Email</label>
                <input type="email" id="company-email" name="email">
            </div>
            
            <div class="luna-crm-form-group">
                <label for="company-website">Strona internetowa</label>
                <input type="url" id="company-website" name="website">
            </div>
            
            <div class="luna-crm-form-group">
                <label for="company-referrer">PolecajƒÖcy</label>
                <select id="company-referrer" name="company_referrer">
                    <option value="">Brak polecajƒÖcego</option>
                    <optgroup label="üë§ Osoby">
                        <?php 
                        $persons = WPMZF_Person::get_persons();
                        foreach ($persons as $person_option): ?>
                            <option value="<?php echo $person_option->id; ?>">üë§ <?php echo esc_html($person_option->get_full_name()); ?></option>
                        <?php endforeach; ?>
                    </optgroup>
                    <optgroup label="üè¢ Firmy">
                        <?php foreach ($companies as $company_option): ?>
                            <option value="<?php echo $company_option->id; ?>">üè¢ <?php echo esc_html($company_option->name); ?></option>
                        <?php endforeach; ?>
                    </optgroup>
                </select>
            </div>
            
            <div class="luna-crm-form-actions">
                <button type="submit" class="button button-primary">Zapisz</button>
                <button type="button" class="button cancel-company">Anuluj</button>
            </div>
            
            <input type="hidden" id="company-id" name="id">
        </form>
    </div>
</div>

<script>
jQuery(document).ready(function($) {
    var modal = $('#company-modal');
    var form = $('#company-form');
    var isEditing = false;
    
    // Otw√≥rz modal dodawania
    $('#add-company, #add-first-company').click(function() {
        openModal('add');
    });
    
    // Otw√≥rz modal edycji
    $(document).on('click', '.edit-company', function() {
        var companyId = $(this).data('company-id');
        openModal('edit', companyId);
    });
    
    // Usu≈Ñ firmƒô
    $(document).on('click', '.delete-company', function() {
        var companyId = $(this).data('company-id');
        if (confirm('Czy na pewno chcesz usunƒÖƒá tƒô firmƒô?')) {
            deleteCompany(companyId);
        }
    });
    
    // Zamknij modal
    $('.luna-crm-modal-close, .cancel-company').click(function() {
        closeModal();
    });
    
    // Zapisz firmƒô
    form.submit(function(e) {
        e.preventDefault();
        saveCompany();
    });
    
    function openModal(action, companyId = null) {
        isEditing = action === 'edit';
        
        if (isEditing) {
            $('#modal-title').text('Edytuj firmƒô');
            loadCompanyData(companyId);
        } else {
            $('#modal-title').text('Dodaj firmƒô');
            form[0].reset();
            $('#company-id').val('');
        }
        
        modal.show();
    }
    
    function closeModal() {
        modal.hide();
        form[0].reset();
        isEditing = false;
    }
    
    function loadCompanyData(companyId) {
        // W rzeczywistej implementacji pobierz dane z AJAX
        // Na razie mock data
        $('#company-id').val(companyId);
        
        // Tutaj mo≈ºna dodaƒá AJAX ≈ºeby pobraƒá dane firmy
        $.ajax({
            url: ajaxurl,
            type: 'POST',
            data: {
                action: 'wpmzf_get_company',
                company_id: companyId,
                nonce: '<?php echo wp_create_nonce("wpmzf_nonce"); ?>'
            },
            success: function(response) {
                if (response.success) {
                    var company = response.data;
                    $('#company-name').val(company.name);
                    $('#company-nip').val(company.nip);
                    $('#company-address').val(company.address);
                    $('#company-phone').val(company.phone);
                    $('#company-email').val(company.email);
                    $('#company-website').val(company.website);
                    $('#company-referrer').val(company.company_referrer || '');
                }
            }
        });
    }
    
    function saveCompany() {
        var formData = form.serialize();
        
        $.ajax({
            url: ajaxurl,
            type: 'POST',
            data: formData + '&action=wpmzf_save_company&nonce=' + '<?php echo wp_create_nonce("wpmzf_nonce"); ?>',
            success: function(response) {
                if (response.success) {
                    closeModal();
                    location.reload();
                } else {
                    alert('B≈ÇƒÖd: ' + response.data);
                }
            }
        });
    }
    
    function deleteCompany(companyId) {
        $.ajax({
            url: ajaxurl,
            type: 'POST',
            data: {
                action: 'wpmzf_delete_company',
                company_id: companyId,
                nonce: '<?php echo wp_create_nonce("wpmzf_nonce"); ?>'
            },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('B≈ÇƒÖd: ' + response.data);
                }
            }
        });
    }
});
</script>

<style>
.company-title-link {
    text-decoration: none;
    color: inherit;
}

.company-title-link:hover {
    color: #0073aa;
}

.company-status {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: bold;
    margin: 5px 0;
}

.status-aktywny {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-nieaktywny {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.status-zarchiwizowany {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.company-header {
    position: relative;
}

.view-company {
    margin-right: 3px;
}

.luna-crm-company-card {
    position: relative;
    padding: 15px;
    background: #fff;
    border: 1px solid #ccd0d4;
    border-radius: 4px;
    margin-bottom: 15px;
}

.luna-crm-company-card:hover {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
</style>
